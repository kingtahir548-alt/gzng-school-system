<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù†ÛŒ Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans Arabic', sans-serif; background-color: #f3f4f6; transition: background-color 0.5s ease, color 0.5s ease; -webkit-tap-highlight-color: transparent; }
        body.dark-mode { background-color: #0f172a; color: #f1f5f9; }
        .dark-mode .input-field { background-color: #1e293b; border-color: #334155; color: white; }
        .dark-mode .bg-white { background-color: #1e293b !important; border-color: #334155 !important; }
        .dark-mode .text-gray-800 { color: #f1f5f9 !important; }
        .dark-mode .text-gray-600 { color: #cbd5e1 !important; }
        
        body.admin-mode { background-color: #020617; color: #f1f5f9; }
        .admin-mode .input-field { background-color: #1e293b; border-color: #334155; color: white; }
        .admin-mode .admin-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); }

        .school-header { background: linear-gradient(135deg, rgba(14, 165, 233, 0.98) 0%, rgba(30, 58, 138, 0.98) 100%), url('school.jpg'); background-size: cover; border-bottom-left-radius: 1.5rem; border-bottom-right-radius: 1.5rem; }
        .btn-neon { background: linear-gradient(90deg, #3b82f6, #8b5cf6); color: white; }
        .btn-white { background-color: white; color: #4b5563; }
        .input-field { border: 1px solid #e5e7eb; }
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        
        /* Report & Print */
        .a4-page { width: 210mm; min-height: 297mm; background: white !important; padding: 15mm; color: #1f2937 !important; }
        @media print { body * { visibility: hidden; } #reportModal, #reportModal * { visibility: visible; } #reportModal { position: absolute; left: 0; top: 0; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen pb-10 relative text-gray-800 bg-gray-50 overflow-y-auto">
    <div id="app" class="w-full"></div>
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-white/95 z-[9999] flex flex-col items-center justify-center"><div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"></div><p class="text-gray-700 font-bold">Ø¬Ø§Ø±ÛŽÚ© Ø¨ÙˆÛ•Ø³ØªÛ•...</p></div>
    <div id="notification" class="hidden fixed top-5 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur-md px-6 py-4 rounded-2xl shadow-xl z-[1000] text-center border border-green-100"><h3 class="font-bold text-gray-800">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø§!</h3></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADty6z48Y3y9ZOYhrj0i5N3PtEFJe-xWg",
            authDomain: "gzng-997cf.firebaseapp.com",
            projectId: "gzng-997cf",
            storageBucket: "gzng-997cf.firebasestorage.app",
            messagingSenderId: "608504174682",
            appId: "1:608504174682:web:0485953a09b51c05d8e063",
            measurementId: "G-KZJDW5SY89"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global Firebase functions
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.query = query;
        window.orderBy = orderBy;
        
        // Load data on startup
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script>
        const LOGO_BASE64 = ""; 
        const LOGO_URL = LOGO_BASE64.length > 50 ? LOGO_BASE64 : 'logo.png';
        
        // âœ… Ù„ÛŽØ±Û• Ù„ÛŒÙ†Ú©Û• Ù†ÙˆÛŽÛŒÛ•Ú©Û• Ø¯Ø§Ù†Ø±Ø§ (Ø¯ÛŽÚ•ÛŒ Ù¦Ù¦)
        const API_URL = 'https://script.google.com/macros/s/AKfycbyaEJ7nH9bORneInV1ev185o0ZLBCoVSZrdhxJ_U1PVII-k_-MlGPwIOVOxvCFL8_6A/exec';

        let state = {
            currentView: 'teacher', 
            activities: [], 
            isAdminAuthenticated: false, 
            adminPassword: '', 
            showMonthModal: false, showReportModal: false, showEditModal: false, editingActivity: null,
            reportScale: 1, viewDay: 'Ø´Û•Ù…Ù…Û•',
            theme: localStorage.getItem('gzng-theme') || 'light', 
            form: { teacherName: '', subject: '', activityName: '', dayOfWeek: '', lessonNumber: '', date: new Date().toISOString().split('T')[0] },
            report: { teacherName: '', activityName: '', date: new Date().toISOString().split('T')[0], orientation: 'landscape', images: [null, null, null, null], imgSettings: Array(4).fill().map(() => ({zoom: 1, x: 50, y: 50})) }
        };

        // Load data from Firebase
        async function loadActivities() {
            if(!window.getDocs) return;
            try {
                // Get data from 'reports' collection
                const q = window.query(window.collection(window.db, "reports"), window.orderBy("timestamp", "desc"));
                const querySnapshot = await window.getDocs(q);
                let data = [];
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                state.activities = data;
                render();
            } catch (error) {
                console.error("Error loading:", error);
            }
        }
        
        // Listen for Firebase ready event
        window.addEventListener('firebase-ready', loadActivities);

        async function handleSubmit() {
            if (!validateForm()) return;
            
            // ðŸ›‘ Conflict Check (Client Side)
            // Ø³Û•ÛŒØ±ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù† Ø¯Û•Ú©Ø§Øª Ø¨Ø²Ø§Ù†ÛŽØª Ø¦Û•Ù… Ú©Ø§ØªÛ• Ú¯ÛŒØ±Ø§ÙˆÛ• ÛŒØ§Ù† Ù†Ø§
            const conflict = state.activities.find(act => 
                act.date === state.form.date && 
                (act.lessonTime === state.form.lessonNumber || act.lessonNumber === state.form.lessonNumber)
            );

            if (conflict) {
                alert(`âš ï¸ Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±ÛŒ!\n\n Ù…Ø§Ù…Û†Ø³ØªØ§ (${conflict.teacherName}) Ù„Û•Ù… Ú©Ø§ØªÛ•Ø¯Ø§ (${conflict.lessonTime}) Ú†Ø§Ù„Ø§Ú©ÛŒ Ù‡Û•ÛŒÛ•.`);
                return;
            }

            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            const newActivity = { 
                ...state.form,
                lessonTime: state.form.lessonNumber, 
                timestamp: Date.now() 
            };

            try {
                // 1. Save to Firebase (Database)
                const docRef = await window.addDoc(window.collection(window.db, "reports"), newActivity);
                
                // 2. Add to local state immediately
                state.activities.unshift({ id: docRef.id, ...newActivity });
                
                // 3. Send Telegram Notification (Ø¨Û• Ø¨Û•Ú©Ø§Ø±Ù‡ÛŽÙ†Ø§Ù†ÛŒ Ø¦Û•Ùˆ Ù„ÛŒÙ†Ú©Û•ÛŒ Ø¯Ø§Ù…Ø§Ù† Ù†Ø§ÙˆÛ•)
                fetch(API_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify(newActivity) 
                });

                showNotification();
                state.form = { teacherName: '', subject: '', activityName: '', dayOfWeek: '', lessonNumber: '', date: new Date().toISOString().split('T')[0] }; 
            } catch (e) { 
                alert("Ú©ÛŽØ´Û• Ù‡Û•ÛŒÛ•: " + e.message); 
            } finally { 
                document.getElementById('loadingOverlay').classList.add('hidden'); 
                render(); 
            }
        }

        async function deleteActivity(id) { 
            if(confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒØª Ø¯Û•ÛŒØ³Ú•ÛŒØªÛ•ÙˆÛ•ØŸ")) { 
                document.getElementById('loadingOverlay').classList.remove('hidden');
                try {
                    await window.deleteDoc(window.doc(window.db, "reports", id));
                    state.activities = state.activities.filter(a => a.id !== id);
                    render();
                } catch(e) { alert("Ù†Û•ØªÙˆØ§Ù†Ø±Ø§ Ø¨Ø³Ú•Ø¯Ø±ÛŽØªÛ•ÙˆÛ•"); }
                document.getElementById('loadingOverlay').classList.add('hidden');
            } 
        }

        function validateForm() { 
            if(!state.form.teacherName || !state.form.lessonNumber || !state.form.subject) {
                alert("ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÙˆÙˆ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù† Ù¾Ú• Ø¨Ú©Û•Ø±Û•ÙˆÛ•");
                return false;
            }
            return true;
        }

        function showNotification() { 
            const n = document.getElementById('notification'); n.classList.remove('hidden'); setTimeout(() => n.classList.add('hidden'), 3000); 
        }
        
        function getLessonName(act) { return act.lessonTime || act.lessonNumber || "Ø¯ÛŒØ§Ø±ÛŒ Ù†Û•Ú©Ø±Ø§ÙˆÛ•"; }
        function parseDate(d) { return d || ""; }
        function toggleTheme() { state.theme = state.theme === 'light' ? 'dark' : 'light'; localStorage.setItem('gzng-theme', state.theme); render(); }
        
        // --- RENDERING ---
        function render() {
            const app = document.getElementById('app');
            document.body.className = `min-h-screen pb-10 relative bg-gray-50 overflow-y-auto ${state.theme === 'dark' ? 'dark-mode' : ''} ${state.currentView === 'admin' ? 'admin-mode' : ''}`;
            
            if (state.currentView === 'admin' && !state.isAdminAuthenticated) {
                app.innerHTML = renderAdminLogin();
                return;
            }

            let content = state.currentView === 'admin' ? renderAdminView() : renderTeacherView();
            app.innerHTML = Header() + Navigation() + content;
            
            if(state.currentView === 'teacher') {
                ['teacherName','subject','activityName','lessonNumber','dayOfWeek'].forEach(f => {
                    const el = document.getElementById(f);
                    if(el) el.value = state.form[f] || '';
                });
                const dEl = document.getElementById('date');
                if(dEl) dEl.value = state.form.date;
            }
        }

        function Header() {
             return `<div class="school-header text-white py-6 px-4 mb-6"><h1 class="text-2xl font-black text-center">Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</h1><div class="text-center mt-2 flex justify-center gap-4"><button onclick="toggleTheme()" class="bg-white/20 px-3 py-1 rounded">Theme</button>${state.isAdminAuthenticated ? `<button onclick="state.isAdminAuthenticated=false;state.currentView='teacher';render()" class="bg-red-500/80 px-3 py-1 rounded">Logout</button>`:''}</div></div>`;
        }

        function Navigation() {
            return `<div class="flex justify-center gap-2 mb-6"><button onclick="state.currentView='teacher';render()" class="btn-white px-6 py-2 rounded-xl font-bold ${state.currentView=='teacher'?'bg-blue-600 !text-white':''}">Ù…Ø§Ù…Û†Ø³ØªØ§</button><button onclick="state.currentView='admin';render()" class="btn-white px-6 py-2 rounded-xl font-bold ${state.currentView=='admin'?'bg-blue-600 !text-white':''}">Ø¦Û•Ø¯Ù…ÛŒÙ†</button></div>`;
        }

        function renderTeacherView() {
            const days = ['Ø´Û•Ù…Ù…Û•', 'ÛŒÛ•Ú©Ø´Û•Ù…Ù…Û•', 'Ø¯ÙˆÙˆØ´Û•Ù…Ù…Û•', 'Ø³ÛŽØ´Û•Ù…Ù…Û•', 'Ú†ÙˆØ§Ø±Ø´Û•Ù…Ù…Û•', 'Ù¾ÛŽÙ†Ø¬Ø´Û•Ù…Ù…Û•', 'Ù‡Û•ÛŒÙ†ÛŒ'];
            const daily = state.activities.filter(a => a.dayOfWeek === state.viewDay);
            
            return `<div class="max-w-4xl mx-auto px-4"><div class="bg-white rounded-2xl p
